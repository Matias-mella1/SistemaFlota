/// Modelo de datos para Prisma (corregido y completo)
// -----------------------------------------------
// Motor recomendado: MySQL o PostgreSQL
// Ejecutar con: npx prisma migrate dev --name init

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// --- ROLES Y USUARIOS ---
model Rol {
  id_rol      Int          @id @default(autoincrement())
  nombre_rol  String       @unique @db.VarChar(50)
  usuario_rol UsuarioRol[]
}

model EstadoUsuario {
  id_estado_usuario Int       @id @default(autoincrement())
  nombre_estado     String    @db.VarChar(20)
  descripcion       String?   @db.VarChar(255)
  usuarios          Usuario[]
}

model TokenRestablecimiento {
  id_token         Int       @id @default(autoincrement())
  codigo_token     String    @unique @db.VarChar(200) // C贸digo 煤nico enviado al usuario
  id_usuario       Int // Usuario al que pertenece el token
  fecha_creacion   DateTime  @default(now()) // Cu谩ndo se gener贸 el token
  fecha_expiracion DateTime // Cu谩ndo vence el token
  fecha_uso        DateTime? // Cu谩ndo se us贸 (si ya fue utilizado)
  direccion_ip     String?   @db.VarChar(64) // IP origen (opcional)

  usuario Usuario @relation(fields: [id_usuario], references: [id_usuario], onDelete: Cascade)

  @@index([id_usuario])
  @@index([fecha_expiracion])
}

model Usuario {
  id_usuario        Int      @id @default(autoincrement())
  rut               String   @db.VarChar(20)
  nombre            String   @db.VarChar(100)
  apellido          String   @db.VarChar(100)
  email             String   @unique @db.VarChar(150)
  telefono          String?  @db.VarChar(25)
  fecha_registro    DateTime @default(now())
  licencia_con      String?  @db.VarChar(100)
  username          String   @unique @db.VarChar(50)
  password_hash     String   @db.VarChar(255)
  id_estado_usuario Int

  estado_usuario EstadoUsuario    @relation(fields: [id_estado_usuario], references: [id_estado_usuario])
  roles          UsuarioRol[]
  turnos         TurnoConductor[]
  documentos     Documento[]
  alertas        Alerta[]
  incidentes     Incidente[]

  //  Relaci贸n corregida (usa el nombre del MODEL)
  tokens TokenRestablecimiento[]
}

model UsuarioRol {
  id_usuario   Int
  id_rol       Int
  estado       String?   @db.VarChar(10)
  fecha_inicio DateTime? @db.Date
  fecha_fin    DateTime? @db.Date

  usuario Usuario @relation(fields: [id_usuario], references: [id_usuario])
  rol     Rol     @relation(fields: [id_rol], references: [id_rol])

  @@id([id_usuario, id_rol])
}

// --- BUSES Y TURNOS ---
model EstadoBus {
  id_estado_bus Int     @id @default(autoincrement())
  nombre_estado String  @db.VarChar(20)
  descripcion   String? @db.VarChar(255)
  buses         Bus[]
}

model Bus {
  id_bus                 Int       @id @default(autoincrement())
  patente                String    @unique @db.VarChar(10)
  modelo                 String?   @db.VarChar(50)
  marca                  String?   @db.VarChar(100)
  anio                   Int?
  capacidad              Int?
  kilometraje            Int?
  combustible            String?   @db.VarChar(20)
  fecha_revision_tecnica DateTime? @db.Date
  fecha_extintor         DateTime? @db.Date
  id_estado_bus          Int

  estado_bus     EstadoBus        @relation(fields: [id_estado_bus], references: [id_estado_bus])
  turnos         TurnoConductor[]
  mantenimientos Mantenimiento[]
  documentos     Documento[]
  alertas        Alerta[]
  incidentes     Incidente[]
}

model EstadoTurno {
  id_estado_turno Int              @id @default(autoincrement())
  nombre_estado   String           @db.VarChar(20)
  descripcion     String?          @db.VarChar(255)
  turnos          TurnoConductor[]
}

model TurnoConductor {
  id_turno        Int       @id @default(autoincrement())
  id_usuario      Int
  id_bus          Int
  hora_inicio     DateTime
  hora_fin        DateTime?
  fecha           DateTime  @db.Date
  id_estado_turno Int
  titulo          String?   @db.VarChar(150)
  descripcion     String?   @db.Text
  ruta_origen     String?   @db.VarChar(100)
  ruta_fin        String?   @db.VarChar(100)

  usuario Usuario     @relation(fields: [id_usuario], references: [id_usuario])
  bus     Bus         @relation(fields: [id_bus], references: [id_bus])
  estado  EstadoTurno @relation(fields: [id_estado_turno], references: [id_estado_turno])
}

// --- MANTENIMIENTOS Y TALLERES ---
model TipoTaller {
  id_tipo_taller Int      @id @default(autoincrement())
  nombre_tipo    String   @db.VarChar(100)
  descripcion    String?  @db.VarChar(255)
  especialidad   String?  @db.VarChar(100)
  talleres       Taller[]
}

model Taller {
  id_taller      Int     @id @default(autoincrement())
  nombre         String  @db.VarChar(100)
  contacto       String? @db.VarChar(100)
  direccion      String? @db.VarChar(200)
  email          String? @db.VarChar(100)
  id_tipo_taller Int

  tipo_taller    TipoTaller      @relation(fields: [id_tipo_taller], references: [id_tipo_taller])
  mecanicos      Mecanico[]
  mantenimientos Mantenimiento[]
}

model Mecanico {
  id_mecanico Int    @id @default(autoincrement())
  id_taller   Int
  nombre      String @db.VarChar(100)
  apellido    String @db.VarChar(100)

  taller     Taller                  @relation(fields: [id_taller], references: [id_taller])
  relaciones MecanicoMantenimiento[]
}

model EstadoMantenimiento {
  id_estado_mantenimiento Int             @id @default(autoincrement())
  nombre_estado           String          @db.VarChar(20)
  descripcion             String?         @db.VarChar(255)
  mantenimientos          Mantenimiento[]
}

model TipoMantenimiento {
  id_tipo_mantenimiento Int             @id @default(autoincrement())
  nombre_tipo           String          @db.VarChar(100)
  descripcion           String?         @db.VarChar(255)
  categoria             String?         @db.VarChar(100)
  mantenimientos        Mantenimiento[]
}

model Mantenimiento {
  id_mantenimiento        Int      @id @default(autoincrement())
  id_bus                  Int
  id_taller               Int
  id_tipo_mantenimiento   Int
  fecha                   DateTime @db.Date
  observaciones           String?  @db.Text
  costo                   Decimal  @db.Decimal(12, 2)
  id_estado_mantenimiento Int

  bus        Bus                     @relation(fields: [id_bus], references: [id_bus])
  taller     Taller                  @relation(fields: [id_taller], references: [id_taller])
  tipo       TipoMantenimiento       @relation(fields: [id_tipo_mantenimiento], references: [id_tipo_mantenimiento])
  estado     EstadoMantenimiento     @relation(fields: [id_estado_mantenimiento], references: [id_estado_mantenimiento])
  repuestos  RepuestoMantenimiento[]
  mecanicos  MecanicoMantenimiento[]
  documentos Documento[]
  alertas    Alerta[]
}

model MecanicoMantenimiento {
  id_mecanico      Int
  id_mantenimiento Int
  actividad        String? @db.VarChar(255)

  mecanico      Mecanico      @relation(fields: [id_mecanico], references: [id_mecanico])
  mantenimiento Mantenimiento @relation(fields: [id_mantenimiento], references: [id_mantenimiento])

  @@id([id_mecanico, id_mantenimiento])
}

// --- REPUESTOS Y PROVEEDORES ---
model EstadoRepuesto {
  id_estado_repuesto Int        @id @default(autoincrement())
  nombre_estado      String     @db.VarChar(20)
  descripcion        String?    @db.VarChar(255)
  repuestos          Repuesto[]
}

model TipoRepuesto {
  id_tipo_repuesto Int        @id @default(autoincrement())
  nombre_tipo      String     @db.VarChar(100)
  descripcion      String?    @db.VarChar(255)
  categoria        String?    @db.VarChar(100)
  repuestos        Repuesto[]
}

model ProveedorRepuesto {
  id_proveedor Int        @id @default(autoincrement())
  nombre       String     @db.VarChar(100)
  direccion    String?    @db.VarChar(200)
  telefono     String?    @db.VarChar(20)
  email        String?    @db.VarChar(100)
  repuestos    Repuesto[]
}

model Repuesto {
  id_repuesto        Int     @id @default(autoincrement())
  nombre             String  @db.VarChar(100)
  descripcion        String? @db.VarChar(255)
  costo              Decimal @db.Decimal(12, 2)
  id_estado_repuesto Int
  id_tipo_repuesto   Int
  id_proveedor       Int

  estado         EstadoRepuesto          @relation(fields: [id_estado_repuesto], references: [id_estado_repuesto])
  tipo           TipoRepuesto            @relation(fields: [id_tipo_repuesto], references: [id_tipo_repuesto])
  proveedor      ProveedorRepuesto       @relation(fields: [id_proveedor], references: [id_proveedor])
  mantenimientos RepuestoMantenimiento[]
}

model RepuestoMantenimiento {
  id_repuesto      Int
  id_mantenimiento Int
  cantidad         Int @default(1)

  repuesto      Repuesto      @relation(fields: [id_repuesto], references: [id_repuesto])
  mantenimiento Mantenimiento @relation(fields: [id_mantenimiento], references: [id_mantenimiento])

  @@id([id_repuesto, id_mantenimiento])
}

// --- INCIDENTES ---
model EstadoIncidente {
  id_estado_incidente Int         @id @default(autoincrement())
  nombre_estado       String      @db.VarChar(20)
  descripcion         String?     @db.VarChar(255)
  incidentes          Incidente[]
}

model TipoIncidente {
  id_tipo_incidente Int         @id @default(autoincrement())
  nombre_tipo       String      @db.VarChar(100)
  descripcion       String?     @db.VarChar(255)
  categoria         String?     @db.VarChar(100)
  incidentes        Incidente[]
}

model Incidente {
  id_incidente        Int      @id @default(autoincrement())
  id_bus              Int
  id_usuario          Int
  descripcion         String?  @db.Text
  fecha               DateTime @db.Date
  urgencia            String?  @db.VarChar(20)
  ubicacion           String?  @db.VarChar(200)
  id_estado_incidente Int
  id_tipo_incidente   Int

  bus        Bus             @relation(fields: [id_bus], references: [id_bus])
  usuario    Usuario         @relation(fields: [id_usuario], references: [id_usuario])
  estado     EstadoIncidente @relation(fields: [id_estado_incidente], references: [id_estado_incidente])
  tipo       TipoIncidente   @relation(fields: [id_tipo_incidente], references: [id_tipo_incidente])
  documentos Documento[]
  alertas    Alerta[]
}

// --- DOCUMENTOS ---
model EstadoDocumento {
  id_estado_documento Int         @id @default(autoincrement())
  nombre_estado       String      @db.VarChar(20)
  descripcion         String?     @db.VarChar(255)
  documentos          Documento[]
}

model TipoDocumento {
  id_tipo_documento Int         @id @default(autoincrement())
  nombre_tipo       String      @db.VarChar(100)
  descripcion       String?     @db.VarChar(255)
  categoria         String?     @db.VarChar(100)
  documentos        Documento[]
}

model Documento {
  id_documento        Int       @id @default(autoincrement())
  nombre_archivo      String    @db.VarChar(100)
  ruta                String    @db.VarChar(255)
  fecha_creacion      DateTime  @db.Date
  fecha_caducidad     DateTime?
  tamano              Decimal?  @db.Decimal(10, 2)
  id_tipo_documento   Int
  id_estado_documento Int
  id_usuario          Int?
  id_bus              Int?
  id_incidente        Int?
  id_mantenimiento    Int?

  tipo          TipoDocumento   @relation(fields: [id_tipo_documento], references: [id_tipo_documento])
  estado        EstadoDocumento @relation(fields: [id_estado_documento], references: [id_estado_documento])
  usuario       Usuario?        @relation(fields: [id_usuario], references: [id_usuario])
  bus           Bus?            @relation(fields: [id_bus], references: [id_bus])
  incidente     Incidente?      @relation(fields: [id_incidente], references: [id_incidente])
  mantenimiento Mantenimiento?  @relation(fields: [id_mantenimiento], references: [id_mantenimiento])
  alertas       Alerta[]
}

// --- ALERTAS ---
model EstadoAlerta {
  id_estado_alerta Int      @id @default(autoincrement())
  nombre_estado    String   @db.VarChar(20)
  descripcion      String?  @db.VarChar(255)
  alertas          Alerta[]
}

model TipoAlerta {
  id_tipo_alerta Int      @id @default(autoincrement())
  nombre_tipo    String   @db.VarChar(100)
  descripcion    String?  @db.VarChar(255)
  categoria      String?  @db.VarChar(100)
  alertas        Alerta[]
}

model Alerta {
  id_alerta        Int      @id @default(autoincrement())
  titulo           String   @db.VarChar(100)
  descripcion      String?  @db.Text
  fecha_creacion   DateTime @db.Date
  prioridad        String?  @db.VarChar(20)
  id_estado_alerta Int
  id_tipo_alerta   Int
  id_usuario       Int?
  id_documento     Int?
  id_bus           Int?
  id_mantenimiento Int?
  id_incidente     Int?

  estado        EstadoAlerta   @relation(fields: [id_estado_alerta], references: [id_estado_alerta])
  tipo          TipoAlerta     @relation(fields: [id_tipo_alerta], references: [id_tipo_alerta])
  usuario       Usuario?       @relation(fields: [id_usuario], references: [id_usuario])
  documento     Documento?     @relation(fields: [id_documento], references: [id_documento])
  bus           Bus?           @relation(fields: [id_bus], references: [id_bus])
  mantenimiento Mantenimiento? @relation(fields: [id_mantenimiento], references: [id_mantenimiento])
  incidente     Incidente?     @relation(fields: [id_incidente], references: [id_incidente])
}
